<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>使命鑑定ナビ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Klee+One&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #1A253A 0%, #3C5A99 100%); 
      --accent-gradient: linear-gradient(135deg, #D4AF37 0%, #b58900 100%); 
      --soft-beige: #F5F1E9; 
      --dusty-pink: #E1BEE7; 
      --gold-accent: #D4AF37; 
      --navy-accent: #0D1B2A; 
      --app-bg: #FFFFFF;
      --text-main: #333333;
      --text-user: #FFFFFF;
      --border-soft: #DDE2E5;
      --transition-base: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: '游明朝', 'YuMincho', serif;
      background: var(--soft-beige);
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNFMUJFRTciIGZpbGwtb3BhY2l0eT0iMC4xNSI+PHBhdGggZD0iTTUwIDUwSDVWNUg1MHZ4NUg1MFoiLz48L2c+PC9nPjwvc3ZnPg=='); 
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow-x: hidden;
      width: 100vw;
      position: relative;
    }

    .app-container {
      width: 100%; max-width: 420px; height: 98vh; background: var(--app-bg);
      display: flex; flex-direction: column; border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow-x: hidden;
      border: 1px solid rgba(212, 175, 55, 0.2); position: relative;
    }

    @media (max-width: 480px) {
      .app-container { height: 100dvh; border-radius: 0; border: none; }
    }
    
    .congrats-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(26, 37, 58, 0.85); display: none;
      justify-content: center; align-items: center; z-index: 1000;
      opacity: 0; transition: opacity 0.5s;
    }
    .congrats-overlay.visible { display: flex; opacity: 1; }
    .congrats-content {
      text-align: center; color: var(--gold-accent);
      font-family: 'Klee One', cursive; animation: congratsPop 1s ease-out;
    }
    .congrats-text { font-size: 2rem; font-weight: bold; margin-bottom: 20px; }
    .congrats-sparkles { font-size: 4rem; animation: sparkleRotate 2s linear infinite; }
    
    header {
      background: var(--primary-gradient); color: #FFF; padding: 15px; 
      text-align: center; position: relative; z-index: 10; transition: var(--transition-base);
    }
    header::after {
      content: ''; position: absolute; bottom: 0; left: 10%;
      width: 80%; height: 1px; background: var(--gold-accent);
    }
    header h1 {
      margin: 0 0 10px 0; font-size: 1.4rem; font-family: 'Playfair Display', serif; 
      letter-spacing: 0.05em; display: flex; justify-content: center; align-items: center;
      transition: var(--transition-base);
    }
    .header-icon { font-size: 1.5rem; color: var(--gold-accent); margin-right: 8px; }
    
    .calculator-container {
      display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 5px; 
      transition: var(--transition-base);
    }
    .name-input-wrapper { position: relative; width: 85%; margin-top: 25px; transition: var(--transition-base); }
    .name-input {
      width: 100%; padding: 10px 18px; border: 2px solid var(--border-soft);
      border-radius: 30px; text-align: center; outline: none; font-size: 1.1rem;
      transition: var(--transition-base); font-family: 'Klee One', cursive; 
    }
    .name-input:focus { border-color: var(--dusty-pink); box-shadow: 0 0 10px rgba(225, 190, 231, 0.5); }
    .name-input-wrapper::after {
      content: '＼ お名前（ひらがな）をどうぞ ／'; position: absolute; top: -28px; 
      left: 50%; transform: translateX(-50%); font-size: 0.8rem; color: var(--gold-accent);
      font-family: 'Klee One', cursive; white-space: nowrap; background: rgba(26, 37, 58, 0.8); 
      padding: 2px 10px; border-radius: 10px; transition: var(--transition-base);
    }
    .calc-btn {
      background: var(--navy-accent); color: var(--gold-accent); border: 1px solid var(--gold-accent);
      padding: 8px 24px; border-radius: 20px; font-family: 'Playfair Display', 'YuMincho', serif;
      font-size: 0.9rem; cursor: pointer; transition: var(--transition-base);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
    }
    .calc-btn:hover { background: var(--gold-accent); color: var(--navy-accent); box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); }
    .calc-btn:active { transform: translateY(2px); }
    .calc-result {
      width: 85%; background: rgba(255,255,255,0.25); border-radius: 12px;
      padding: 8px; font-size: 0.85rem; display: none; text-align: center; color: #FFF;
      border: 1px solid rgba(255,255,255,0.4); font-family: 'Playfair Display', serif;
    }
    .calc-result.visible { display: block; animation: fadeIn 0.5s ease-out; }
    .number-highlight { font-size: 1.3rem; color: var(--gold-accent); font-weight: bold; position: relative; transition: var(--transition-base); }
    
    header.compact { padding: 10px; }
    header.compact h1 { display: none; }
    header.compact .calculator-container { 
      flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 0; 
    }
    header.compact .name-input-wrapper { margin-top: 0; width: auto; flex: 1; max-width: 140px; }
    header.compact .name-input-wrapper::after { display: none; }
    header.compact .name-input { padding: 6px 10px; font-size: 0.9rem; }
    header.compact .calc-btn { padding: 6px 12px; font-size: 0.8rem; }
    header.compact .calc-result { width: 100%; margin-top: 0; padding: 4px; font-size: 0.8rem; }

    @keyframes sparkleRotate { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; } 100% { transform: scale(1) rotate(360deg); opacity: 1; } }
    @keyframes congratsPop { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    
    #chat-container {
      flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px;
      background: #FAFCFD; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNEMDRBRjM3IiBmaWxsLW9wYWNpdHQ9IjAuMDQiPjxwYXRoIGQ0PSJNNDAgNDBDNTUuMjYgNDAgNzQgNjcuMzMgNzQgNTBDNzQgMzIuNjcgNTUuMjYgMCA0MCAwUzYgMzIuNjcgNiA1MEM2IDY3LjMzIDguNDcgNDAgNDAgNDBaIi8+PC9nPjwvc3ZnPg=='); 
      scroll-behavior: smooth; position: relative;
    }
    #chat-container::-webkit-scrollbar { width: 6px; }
    #chat-container::-webkit-scrollbar-thumb { background-color: #DDE2E5; border-radius: 10px; }
    
    .message {
      max-width: 85%; padding: 14px 18px; border-radius: 18px; font-size: 0.95rem;
      line-height: 1.6; position: relative; z-index: 2;
      word-wrap: break-word; overflow-wrap: anywhere; word-break: normal;
    }
    .user-message {
      align-self: flex-end; background: var(--primary-gradient); color: var(--text-user);
      border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--gold-accent);
    }
    .app-message {
      align-self: flex-start; background: #FFF; border: 1px solid #EEF2F5; color: var(--text-main);
      border-bottom-left-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    .app-message::before {
      content: '\f19d'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute;
      top: -12px; left: -12px; font-size: 1.2rem; color: var(--gold-accent); background: #FFF;
      border-radius: 50%; padding: 2px;
    }
    
    /* ★新設：お守り画像用のCSS */
    .amulet-image {
      width: 100%; max-width: 300px; height: auto; border-radius: 12px; margin-top: 15px; 
      border: 3px solid #FFF; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: var(--transition-base); cursor: pointer; display: block;
    }
    .amulet-image:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3); }

    .special-arrival { position: relative; }
    .special-arrival::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 10px; height: 10px; background: transparent; border: 2px solid var(--gold-accent);
      border-radius: 50%; animation: specialRingPulse 1.5s ease-out forwards; z-index: 1; pointer-events: none;
    }
    @keyframes specialRingPulse { 0% { width: 10px; height: 10px; opacity: 1; border-width: 5px; } 50% { width: 150%; height: 150%; opacity: 0.5; border-width: 2px; } 100% { width: 200%; height: 200%; opacity: 0; border-width: 0px; } }
    
    .system-message {
      align-self: center; background: #FFF3CD; color: #856404; padding: 8px 16px; border-radius: 15px;
      font-size: 0.8rem; text-align: center; border: 1px solid var(--gold-accent); font-family: 'Klee One', cursive;
    }
    .typing-indicator {
      align-self: flex-start; display: flex; gap: 5px; padding: 12px 18px; background: #FFF;
      border: 1px solid #EEF2F5; border-radius: 20px; border-bottom-left-radius: 4px;
    }
    .typing-indicator span { width: 6px; height: 6px; background: #BDC3C7; border-radius: 50%; animation: bounce 1.4s infinite; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .input-area { display: flex; padding: 12px; border-top: 1px solid #EEF2F5; gap: 8px; background: #FFF; z-index: 10; }
    #chat-input {
      flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #E5E8E8; outline: none;
      font-size: 0.95rem; transition: var(--transition-base); width: 100%;
    }
    #chat-input:focus { border-color: var(--dusty-pink); box-shadow: 0 0 10px rgba(225, 190, 231, 0.5); }
    #send-btn {
      background: linear-gradient(135deg, #D4AF37 0%, #b58900 100%); color: #FFF; border: none;
      border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0; cursor: pointer; display: flex; align-items: center;
      justify-content: center; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); transition: var(--transition-base); position: relative;
    }
    #send-btn:active { transform: translateY(2px); }
    #send-btn:hover { filter: brightness(1.1); box-shadow: 0 4px 20px rgba(212, 175, 55, 0.6); }
    #send-btn i { font-size: 1.2rem; color: #FFF; }
    #send-btn:hover i { animation: planeFly 0.5s ease-out; }
    @keyframes planeFly { 0% { transform: translate(0, 0); opacity: 1; } 50% { transform: translate(15px, -15px); opacity: 0; } 100% { transform: translate(0, 0); opacity: 1; } }
  </style>
</head>
<body>
  <div id="congrats-overlay" class="congrats-overlay">
    <div class="congrats-content">
      <div class="congrats-sparkles"><i class="fas fa-magic"></i></div>
      <div class="congrats-text">おめでとう！</div>
      <div class="congrats-subtext">あなたの「音」が見つかりました</div>
    </div>
  </div>

  <div class="app-container">
    <header id="main-header">
      <h1><i class="fas fa-gem header-icon"></i>使命鑑定ナビ</h1>
      <div class="calculator-container">
        <div class="name-input-wrapper">
          <input type="text" id="name-input" class="name-input" placeholder="" autocomplete="off">
        </div>
        <button id="calc-btn" class="calc-btn"><i class="fas fa-sparkles"></i> 音を導き出す</button>
        <div id="calc-result" class="calc-result"></div>
      </div>
    </header>
    <div id="chat-container">
      <div class="message app-message">こんにちは。<br>あなたの「音」に刻まれた使命を解き明かし、魂が望む未来への道標をお渡しします。<br>まずはお名前をひらがなで入力し、「音を導き出す」ボタンを押してください。</div>
    </div>
    <div class="input-area">
      <input type="text" id="chat-input" placeholder="お悩みをご相談ください...">
      <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <script>
    const charValues = {
      'あ':18,'い':5,'う':19,'え':43,'お':40,'か':25,'き':29,'く':11,'け':35,'こ':16,'さ':28,'し':23,'す':21,'せ':36,'そ':30,'た':26,'ち':27,'つ':44,'て':9,'と':17,'な':14,'に':32,'ぬ':39,'ね':46,'の':20,'は':42,'ひ':1,'ふ':2,'へ':22,'ほ':47,'ま':6,'み':3,'む':13,'め':10,'も':33,'や':15,'ゆ':37,'よ':4,'ら':31,'り':8,'る':12,'れ':24,'ろ':34,'わ':7,'ん':48,
      'が':-25,'ぎ':-29,'ぐ':-11,'げ':-35,'ご':-16,'ざ':-28,'じ':-23,'ず':-21,'ぜ':-36,'ぞ':-30,'だ':-26,'ぢ':-27,'づ':-44,'で':-9,'ど':-17,'ば':-42,'び':-1,'ぶ':-2,'べ':-22,'ぼ':-47,'ぱ':-42,'ぴ':-1,'ぷ':-2,'ぺ':-22,'ぽ':-47
    };

    const congratsOverlay = document.getElementById('congrats-overlay');
    const mainHeader = document.getElementById('main-header');
    const nameInput = document.getElementById('name-input');
    const calcBtn = document.getElementById('calc-btn');
    const calcResult = document.getElementById('calc-result');
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    
    let currentNumber = null;

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    });

    calcBtn.addEventListener('click', () => {
      const name = nameInput.value.replace(/[^ぁ-んが-ぼぱ-ぽ]/g, '');
      if (!name) { 
        calcResult.innerHTML = `ひらがなでお名前を入力してください`;
        calcResult.classList.add('visible'); 
        currentNumber = null; return; 
      }
      
      let sum = 0;
      for (let c of name) { if (charValues[c] !== undefined) sum += charValues[c]; }
      let total = Math.abs(sum);
      while (total >= 10) { total = total.toString().split('').map(Number).reduce((a,b)=>a+b, 0); }
      
      if (currentNumber !== total) {
        currentNumber = total;
        calcResult.innerHTML = `あなたの音: <span class="number-highlight">${total}の音</span>`;
        calcResult.classList.add('visible');
        showCongratsAnimation(); 
      } else {
        calcResult.classList.add('visible');
      }
      mainHeader.classList.add('compact');
    });
    
    nameInput.addEventListener('focus', () => { mainHeader.classList.remove('compact'); });

    function showCongratsAnimation() {
      congratsOverlay.classList.add('visible');
      setTimeout(() => { congratsOverlay.classList.remove('visible'); }, 1500);
    }

    async function generateAIResponse(userText) {
      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      indicator.innerHTML = '<span></span><span></span><span></span>';
      chatContainer.appendChild(indicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userText: userText, currentNumber: currentNumber })
        });
        
        const result = await response.json();
        indicator.remove();

        if (result.error) { appendMessage("エラー: " + result.error, 'system'); return; }
        
        // ★修正：Base64文字列から完全なデータURLを再構築する
        const imageDataUrl = 'data:image/png;base64,' + result.imageBase64;

        // ★修正：テキストと構築したデータURLを一緒に表示する
        appendMessage(result.text, 'app', imageDataUrl);

      } catch (e) {
        indicator.remove();
        appendMessage("通信失敗。ネット接続を確認してください。", 'system');
      }
    }

    // ★修正：第3引数でデータURLを受け取る
    function appendMessage(text, sender, imageDataUrl = null) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message ${sender === 'app' ? 'special-arrival' : ''}`;
      
      let contentHtml = text.replace(/\n/g, '<br>');
      
      // ★AIからの返答で、かつデータURLがある場合は、画像も追加する
      if (sender === 'app' && imageDataUrl) {
        contentHtml += `<img src="${imageDataUrl}" class="amulet-image" alt="あなただけの魂のお守り" onclick="window.open('${imageDataUrl}', '_blank')">`;
      }
      
      div.innerHTML = contentHtml;
      chatContainer.appendChild(div);
      div.style.animation = 'fadeIn 0.5s ease-out';

      if (sender === 'app') {
        setTimeout(() => { div.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
      } else {
        setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
      }
    }

    sendBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!currentNumber) { 
        appendMessage("上の「音を導き出す」ボタンを押して、数秘を確定させてくださいね。", 'system'); return; 
      }
      if (text) {
        appendMessage(text, 'user');
        chatInput.value = '';
        generateAIResponse(text);
      }
    });

    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendBtn.click(); });
    congratsOverlay.addEventListener('click', () => { congratsOverlay.classList.remove('visible'); });
  </script>
</body>
</html>
